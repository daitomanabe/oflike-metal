# oflike-metal Feature Development Orchestrator
#
# 3つのPhaseで機能を段階的に実装:
# - Phase 1: 基盤強化 (ofFbo, ofShader, ofNode, ofCamera)
# - Phase 2: 表現力向上 (ofVbo, Shader Lighting, ofTexture拡張)
# - Phase 3: メディア対応 (ofVideoPlayer, ofVideoGrabber, Image Filters)
#
# Flow:
#   git_setup → phase1_planner → phase1_builder → phase1_tester
#             → phase2_planner → phase2_builder → phase2_tester
#             → phase3_planner → phase3_builder → phase3_tester
#             → finalizer → LOOP_COMPLETE
#
# Usage:
#   ralph run -c ralph.yml -p "PROMPT.md"

cli:
  backend: "claude"

event_loop:
  completion_promise: "LOOP_COMPLETE"
  max_iterations: 100
  prompt_file: "PROMPT.md"
  starting_event: "work.start"
  checkpoint_interval: 1

core:
  scratchpad: ".agent/scratchpad.md"
  specs_dir: "./specs/"

hats:
  git_setup:
    name: "Git Setup"
    description: |
      Git/GitHub初期化と状態確認。

      実行手順:
      1. gh auth status (認証確認、失敗→LOOP_COMPLETE)
      2. git status で現在の状態確認
      3. 未コミットの変更があれば git add -A && git commit
      4. git push origin master

      全て成功 → git.ready / いずれか失敗 → LOOP_COMPLETE

      完了後:
      1. .agent/iteration.log に記録
    triggers:
      - "work.start"
    publishes:
      - "git.ready"
      - "LOOP_COMPLETE"

  phase1_planner:
    name: "Phase1 Planner"
    description: |
      Phase1 (基盤強化) の設計・計画。
      対象: ofFbo, ofShader, ofNode, ofCamera

      実行手順:
      1. 既存コードを分析 (src/oflike/, src/render/)
      2. 各クラスのAPI設計を specs/phase1_*.md に記述
      3. 依存関係を整理 (ofNode → ofCamera の順序等)
      4. .agent/scratchpad.md に進捗記録

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push
    triggers:
      - "git.ready"
    publishes:
      - "phase1.planned"

  phase1_builder:
    name: "Phase1 Builder"
    description: |
      Phase1の実装。
      対象: ofFbo, ofShader, ofNode, ofCamera

      実装順序:
      1. ofNode (シーングラフ基盤)
      2. ofCamera (ofNodeを継承)
      3. ofFbo (オフスクリーンレンダリング)
      4. ofShader (カスタムシェーダー)

      各クラスごとに:
      - ヘッダファイル (.h) 作成
      - 実装ファイル (.cpp/.mm) 作成
      - 既存コードとの統合

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push
    triggers:
      - "phase1.planned"
      - "phase1.test.fix_requested"
    publishes:
      - "phase1.built"

  phase1_tester:
    name: "Phase1 Tester"
    description: |
      Phase1のテスト。

      実行手順:
      1. テストアプリ apps/test_phase1/ を作成
      2. ビルド (./scripts/build_app.sh test_phase1)
      3. 各機能の動作確認
      4. 問題発見時は phase1.test.fix_requested
      5. 全て成功なら phase1.complete

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push
    triggers:
      - "phase1.built"
    publishes:
      - "phase1.test.fix_requested"
      - "phase1.complete"

  phase2_planner:
    name: "Phase2 Planner"
    description: |
      Phase2 (表現力向上) の設計・計画。
      対象: ofVbo, Shader-based Lighting, ofTexture拡張

      実行手順:
      1. Phase1の成果を確認
      2. 各機能のAPI設計を specs/phase2_*.md に記述
      3. Metal シェーダー拡張計画
      4. .agent/scratchpad.md に進捗記録

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push
    triggers:
      - "phase1.complete"
    publishes:
      - "phase2.planned"

  phase2_builder:
    name: "Phase2 Builder"
    description: |
      Phase2の実装。
      対象: ofVbo, Shader-based Lighting, ofTexture拡張

      実装順序:
      1. ofVbo (GPU頂点バッファ)
      2. ofTexture拡張 (mipmap, wrap, filter)
      3. Shader-based Lighting (ofLight/ofMaterial統合)

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push
    triggers:
      - "phase2.planned"
      - "phase2.test.fix_requested"
    publishes:
      - "phase2.built"

  phase2_tester:
    name: "Phase2 Tester"
    description: |
      Phase2のテスト。

      実行手順:
      1. テストアプリ apps/test_phase2/ を作成
      2. ビルド確認
      3. ライティングの視覚確認
      4. VBOパフォーマンス確認
      5. 問題発見時は phase2.test.fix_requested

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push
    triggers:
      - "phase2.built"
    publishes:
      - "phase2.test.fix_requested"
      - "phase2.complete"

  phase3_planner:
    name: "Phase3 Planner"
    description: |
      Phase3 (メディア対応) の設計・計画。
      対象: ofVideoPlayer, ofVideoGrabber, Image Filters

      実行手順:
      1. AVFoundation APIの調査
      2. 各機能のAPI設計を specs/phase3_*.md に記述
      3. Accelerate/Metal Compute活用計画
      4. .agent/scratchpad.md に進捗記録

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push
    triggers:
      - "phase2.complete"
    publishes:
      - "phase3.planned"

  phase3_builder:
    name: "Phase3 Builder"
    description: |
      Phase3の実装。
      対象: ofVideoPlayer, ofVideoGrabber, Image Filters

      実装順序:
      1. ofVideoPlayer (AVPlayer backend)
      2. ofVideoGrabber (AVCaptureSession backend)
      3. Image Filters (blur, sharpen, contrast等)

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push
    triggers:
      - "phase3.planned"
      - "phase3.test.fix_requested"
    publishes:
      - "phase3.built"

  phase3_tester:
    name: "Phase3 Tester"
    description: |
      Phase3のテスト。

      実行手順:
      1. テストアプリ apps/test_phase3/ を作成
      2. 動画再生テスト
      3. カメラ入力テスト
      4. フィルター適用テスト
      5. 問題発見時は phase3.test.fix_requested

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push
    triggers:
      - "phase3.built"
    publishes:
      - "phase3.test.fix_requested"
      - "phase3.complete"

  finalizer:
    name: "Finalizer"
    description: |
      全Phase完了後の最終処理。

      実行手順:
      1. 全テストの最終確認
      2. ドキュメント更新 (README, API docs)
      3. COMPLETION_REPORT.md 生成
      4. 最終 git push
      5. LOOP_COMPLETE 発行

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push
    triggers:
      - "phase3.complete"
    publishes:
      - "LOOP_COMPLETE"

# Task tracking
tasks:
  enabled: true

# Memory
memories:
  enabled: true
  inject: auto
  budget: 3000
