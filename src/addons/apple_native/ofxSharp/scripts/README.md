# ofxSharp Model Conversion Scripts

This directory contains scripts for converting SHARP (Single-image to High-fidelity Appearance Reconstruction via neural Prefiltered splatting) models to Core ML format for Neural Engine acceleration.

## Prerequisites

### Python Environment

Install required Python packages:

```bash
pip install torch torchvision coremltools numpy pillow
```

Or use a virtual environment:

```bash
python3 -m venv venv
source venv/bin/activate  # On macOS/Linux
pip install -r requirements.txt
```

### PyTorch Model

You need a trained SHARP PyTorch model (`.pth` or `.pt` file). You can:

1. **Train your own** following the [Apple ML-SHARP repository](https://github.com/apple/ml-sharp)
2. **Download a pretrained model** (if available)
3. **Use the placeholder model** for testing (generated by the script)

## Usage

### Basic Conversion

Convert a PyTorch model to Core ML:

```bash
python convert_to_coreml.py \
  --input /path/to/sharp_model.pth \
  --output ../models/sharp.mlpackage
```

### Advanced Options

#### Custom Input Resolution

Specify input image dimensions:

```bash
python convert_to_coreml.py \
  --input sharp_model.pth \
  --output ../models/sharp.mlpackage \
  --width 1024 \
  --height 768
```

#### INT8 Quantization

Apply quantization for smaller model size (faster inference, slightly lower accuracy):

```bash
python convert_to_coreml.py \
  --input sharp_model.pth \
  --output ../models/sharp_quantized.mlpackage \
  --quantize
```

#### Compute Units

Control where the model runs:

```bash
# ALL: Neural Engine + GPU (recommended, fastest)
python convert_to_coreml.py \
  --input sharp_model.pth \
  --output ../models/sharp.mlpackage \
  --compute-units ALL

# CPU_AND_NE: Neural Engine + CPU (no GPU)
python convert_to_coreml.py \
  --input sharp_model.pth \
  --output ../models/sharp.mlpackage \
  --compute-units CPU_AND_NE

# CPU_ONLY: CPU only (slowest, for debugging)
python convert_to_coreml.py \
  --input sharp_model.pth \
  --output ../models/sharp.mlpackage \
  --compute-units CPU_ONLY
```

#### Skip Validation

Skip numerical validation (faster):

```bash
python convert_to_coreml.py \
  --input sharp_model.pth \
  --output ../models/sharp.mlpackage \
  --skip-validation
```

## Model Architecture

The SHARP model converts a single RGB image to 3D Gaussian Splatting parameters:

### Input

- **Shape**: `(1, 3, H, W)`
- **Type**: `float32`
- **Range**: `[0, 1]` normalized RGB
- **Default Resolution**: 512×512

### Outputs

The model outputs structured Gaussian parameters:

| Output      | Shape    | Description                            |
|-------------|----------|----------------------------------------|
| `positions` | `(N, 3)` | 3D positions (x, y, z)                |
| `colors`    | `(N, 3)` | RGB colors [0, 1]                     |
| `opacities` | `(N, 1)` | Alpha values [0, 1]                   |
| `scales`    | `(N, 3)` | Scale factors for covariance          |
| `rotations` | `(N, 4)` | Quaternions (w, x, y, z) for rotation |

Where `N` is the number of Gaussians (typically 1000-10000).

## Performance Targets

### Neural Engine (Apple Silicon)

- **Inference Time**: < 1 second
- **Memory**: Unified Memory (zero-copy)
- **Devices**: M1, M2, M3, M4 series

### Performance Tips

1. **Use ALL compute units** for best performance
2. **Enable quantization** for faster inference on Neural Engine
3. **Match input resolution** to your use case (512×512 is recommended)
4. **Batch size = 1** (Neural Engine optimized for single-image inference)

## Integration with ofxSharp

After conversion, use the model in your C++ code:

```cpp
#include "ofxSharp.h"

// Setup
Sharp::SharpModel model;
model.load("sharp.mlmodelc");  // Note: .mlmodelc (compiled), not .mlpackage

// Inference
ofImage inputImage;
inputImage.load("photo.jpg");

Sharp::GaussianCloud cloud = model.predict(inputImage.getPixels());

// Render
Sharp::GaussianRenderer renderer;
renderer.setup(1920, 1080);
renderer.render(cloud, camera);
```

## Troubleshooting

### "Model loading failed"

- Ensure the `.mlpackage` is compiled to `.mlmodelc` by Xcode
- Check that the model is in the correct directory
- Verify the model format is "ML Program" (not Neural Network)

### "Numerical validation failed"

- This is normal for quantized models (increase `--tolerance`)
- Core ML may use different precision than PyTorch
- Large differences indicate a conversion issue

### "Neural Engine not used"

- Check that compute units are set to `ALL` or `CPU_AND_NE`
- Verify you're running on Apple Silicon (not Intel)
- Some operations may fall back to GPU/CPU automatically

### "Out of memory"

- Reduce input resolution (`--width` and `--height`)
- Enable quantization (`--quantize`)
- Reduce the number of output Gaussians in the model

## Model Compilation

Core ML models need to be compiled before use:

### Automatic (Xcode)

When you build the Xcode project, `.mlpackage` files are automatically compiled to `.mlmodelc`.

### Manual (coremlcompiler)

```bash
# Compile .mlpackage to .mlmodelc
xcrun coremlcompiler compile sharp.mlpackage output_dir/

# Result: output_dir/sharp.mlmodelc/
```

## File Structure

```
ofxSharp/
├── scripts/
│   ├── README.md                  # This file
│   ├── convert_to_coreml.py       # PyTorch → Core ML converter
│   └── requirements.txt           # Python dependencies
├── models/
│   ├── sharp.mlpackage            # Core ML model (source)
│   └── sharp.mlmodelc/            # Compiled model (auto-generated)
└── src/
    ├── SharpModel.h               # C++ interface
    └── SharpModel.mm              # Core ML integration
```

## References

- **Apple ML-SHARP**: https://github.com/apple/ml-sharp
- **Core ML Tools**: https://coremltools.readme.io/
- **3D Gaussian Splatting**: https://repo-sam.inria.fr/fungraph/3d-gaussian-splatting/
- **Neural Engine**: https://machinelearning.apple.com/research/neural-engine

## License

MIT License - See LICENSE file in project root

## Support

For issues specific to:
- **Model conversion**: Check Core ML Tools documentation
- **ofxSharp integration**: See main ofxSharp README.md
- **SHARP architecture**: Refer to Apple ML-SHARP repository
